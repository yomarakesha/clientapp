# Архитектура: NVR + MediaMTX + Профессиональный Клиент

## 🏗️ Как это работает

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  130 IP-Камер (RTSP потоки)                                    │
│  ↓ ↓ ↓ ... ↓ (все потоки одновременно)                         │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  NVR Регистратор (Hikvision, Dahua и т.д.)            │    │
│  │  - Получает все 130 потоков                           │    │
│  │  - Записывает на локальное хранилище                  │    │
│  │  - Выдаёт потоки наружу (например, rtsp://nvr:554)    │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
                   RTSP поток от NVR
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      MediaMTX Сервер                            │
│  rtsp://mediamtx-server:8554/                                  │
│                                                                 │
│  📋 mediamtx.yml (конфиг):                                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ paths:                                                   │  │
│  │   camera_1:                                              │  │
│  │     source: rtsp://nvr:554/ch1                           │  │
│  │   camera_2:                                              │  │
│  │     source: rtsp://nvr:554/ch2                           │  │
│  │   ...                                                    │  │
│  │   camera_130:                                            │  │
│  │     source: rtsp://nvr:554/ch130                         │  │
│  │                                                          │  │
│  │  📍 Результат: 130 потоков доступны как:               │  │
│  │     rtsp://mediamtx-server:8554/camera_1                │  │
│  │     rtsp://mediamtx-server:8554/camera_2                │  │
│  │     ...                                                  │  │
│  │     rtsp://mediamtx-server:8554/camera_130              │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│        Профессиональный Клиент (Ваше приложение)                │
│                                                                 │
│  1️⃣  АВТОМАТИЧЕСКИ получает конфиг из MediaMTX                  │
│      GET /list → получает список всех камер                    │
│                                                                 │
│  2️⃣  ЗАГРУЖАЕТ 130+ камер:                                       │
│     - Ленивая загрузка (только видимые)                        │
│     - Кэширование по группам                                  │
│     - Многоуровневая иерархия                                 │
│                                                                 │
│  3️⃣  ОТОБРАЖАЕТ одновременно:                                    │
│     - До 16 в сетке (остальные по требованию)                 │
│     - Поиск по названию                                       │
│     - Фильтрация по группам                                   │
│     - Фильтрация по статусу                                   │
│                                                                 │
│  4️⃣  УПРАВЛЯЕТ:                                                  │
│     - Запись отдельных потоков                                │
│     - Скриншоты                                               │
│     - Редактирование видео                                    │
│     - PTZ команды                                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 📡 Детально: Как добавить 130 камер

### Шаг 1: Настройка NVR
NVR уже имеет все 130 камер и выдаёт их как потоки. Например:
- Hikvision: `rtsp://nvr-ip:554/Streaming/Channels/101` (канал 1)
- Dahua: `rtsp://nvr-ip:554/stream/1` (поток 1)

### Шаг 2: Настройка MediaMTX
Отредактируйте файл `mediamtx.yml`:

```yaml
paths:
  camera_1:
    source: rtsp://192.168.1.100:554/ch1
  camera_2:
    source: rtsp://192.168.1.100:554/ch2
  camera_3:
    source: rtsp://192.168.1.100:554/ch3
  # ... продолжайте до camera_130
  camera_130:
    source: rtsp://192.168.1.100:554/ch130
```

Или сгенерируйте автоматически (Python):
```python
with open('mediamtx.yml', 'w') as f:
    f.write('paths:\n')
    for i in range(1, 131):
        f.write(f'''  camera_{i}:
    source: rtsp://192.168.1.100:554/ch{i}
''')
```

### Шаг 3: Запуск MediaMTX
```bash
mediamtx mediamtx.yml
```

### Шаг 4: Проверка в клиенте
Приложение **АВТОМАТИЧЕСКИ** получит список всех 130 камер через:
```
GET http://mediamtx-server:9997/list
```

Результат (JSON):
```json
{
  "items": {
    "camera_1": {...},
    "camera_2": {...},
    ...
    "camera_130": {...}
  }
}
```

## ✅ Ответы на вопросы

### ❓ "Будет ли приложение отображать все 130 камер с одного потока от регистратора?"

**Ответ: ДА, но с оговорками:**

✅ **Технически возможно:**
- MediaMTX расшифровывает 1 поток от NVR
- MediaMTX создаёт 130 отдельных виртуальных потоков
- Приложение подключается к каждому виртуальному потоку

❌ **Ограничения:**
- **CPU**: 130 потоков требуют 30-50% CPU (зависит от разрешения)
- **Память**: ~1-2 ГБ для 130 потоков
- **Сеть**: Каждый поток кодируется отдельно (~2-5 Mbps каждый)
- **Одновременный просмотр**: Рекомендуется одновременно показывать 4-16 (больше = лаги)

### ❓ "Как добавить пути от MediaMTX в приложение?"

**Ответ: АВТОМАТИЧЕСКИ!**

Приложение будет:
1. Подключиться к MediaMTX API
2. Получить полный список потоков
3. Автоматически создать камеры
4. Можете их группировать по отделам/зонам

### ❓ "Нужно ли вручную прописывать все 130 адресов?"

**Ответ: НЕТ!**

Есть 3 способа:

**Способ 1: Автоимпорт (рекомендуется)**
```python
# Приложение автоматически получает список из MediaMTX
GET http://mediamtx-server:9997/list
```

**Способ 2: Загрузка из файла**
```json
// cameras.json
[
  {"name": "Camera 1", "url": "rtsp://mediamtx:8554/camera_1", "group": "Zone A"},
  {"name": "Camera 2", "url": "rtsp://mediamtx:8554/camera_2", "group": "Zone A"},
  ...
]
```

**Способ 3: Импорт из конфига MediaMTX**
```
mediamtx.yml → парсим → автоматически создаём в приложении
```

## 🎯 Сценарий использования

```
1. На сервере с MediaMTX:
   ✓ Все 130 камер получают потоки от NVR
   ✓ MediaMTX переранслирует их

2. На клиентской машине:
   ✓ Запускаете приложение
   ✓ Нажимаете "Import from MediaMTX"
   ✓ Приложение автоматически загружает все 130 камер
   ✓ Вы видите список в левом дереве

3. Просмотр:
   ✓ Выбираете камеру из списка
   ✓ Нажимаете Play
   ✓ Видите её поток прямо с MediaMTX сервера

4. Масштабирование:
   ✓ Можете добавить ещё NVR, ещё потоки
   ✓ Приложение будет работать с неограниченным количеством

```

## 💡 Оптимизация для 130+ камер

### В MediaMTX:
```yaml
paths:
  camera_*:
    source: rtsp://nvr:554/ch*
    rtspTransport: tcp  # Надёжнее UDP
    readTimeout: 10s
    writeTimeout: 10s
```

### В приложении (новые функции):
- **Ленивая загрузка** - видео начинает воспроизводиться только когда выбрана
- **Кэширование** - сохраняет метаданные в памяти
- **Группировка** - разбивает на логические группы
- **Поиск** - быстрый поиск по названию
- **Фильтры** - показать только онлайн, только запись, только недоступные

## 🚀 Архитектура лучше всего работает когда:

✅ NVR + MediaMTX на одном сервере (локальная сеть)
✅ Клиент подключается к MediaMTX через LAN
✅ Разрешение камер: 720p-1080p (не 4K)
✅ Одновременный просмотр: 4-16 камер максимум

## ⚠️ Если проблемы:

| Проблема | Решение |
|----------|---------|
| Лаги при 130 камерах | Показывайте 4-16, остальные в списке |
| Высокий CPU на сервере | Снизьте кодек на NVR (H.264 вместо H.265) |
| Потери потоков | Включите TCP в MediaMTX вместо UDP |
| Нехватка памяти | Увеличьте RAM или используйте меньше одновременных потоков |
| Задержка видео | Уменьшите буфер, используйте меньше потоков одновременно |

---

**Итого:** Да, приложение ПОЛНОСТЬЮ готово работать с 130+ камерами через один или несколько потоков от NVR через MediaMTX!
